<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Caravan Battery Calculator</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        /* Custom styles to enhance Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom scrollbar for a cleaner look in dark mode */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
        /* Style for range slider track */
        input[type="range"]::-webkit-slider-runnable-track {
            background: #374151; /* bg-gray-700 */
            height: 4px;
            border-radius: 2px;
        }
        input[type="range"]::-moz-range-track {
            background: #374151; /* bg-gray-700 */
            height: 4px;
            border-radius: 2px;
        }
         /* Style for range slider thumb */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6; /* bg-blue-500 */
            cursor: pointer;
            border-radius: 50%;
            margin-top: -8px;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6; /* bg-blue-500 */
            cursor: pointer;
            border-radius: 50%;
        }
        /* Loading spinner */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    <div class="max-w-screen-2xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white">Advanced Caravan Battery Calculator</h1>
            <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">A 24-hour power system simulator for your mobile setup.</p>
        </header>

        <div class="grid grid-cols-1 xl:grid-cols-5 gap-8">
            <div class="xl:col-span-2 flex flex-col gap-8">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-4 border-b border-gray-200 dark:border-gray-700 pb-2">System Setup</h2>
                    
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-blue-500 dark:text-blue-400">Battery</h3>
                        <div>
                            <label for="batteryCapacity" class="block text-sm font-medium">Total Capacity (Ah)</label>
                            <input type="number" id="batteryCapacity" value="200" class="mt-1 block w-full bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="batteryType" class="block text-sm font-medium">Battery Type</label>
                            <select id="batteryType" class="mt-1 block w-full bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="lithium">Lithium (LiFePO4)</option>
                                <option value="agm">AGM</option>
                                <option value="lead-acid">Lead-Acid</option>
                            </select>
                        </div>
                    </div>

                    <div class="space-y-4 mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-yellow-500 dark:text-yellow-400">Solar & Location</h3>
                        <div>
                            <label for="solarWattage" class="block text-sm font-medium">Total Solar Panel Wattage (W)</label>
                            <input type="number" id="solarWattage" value="400" class="mt-1 block w-full bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="locationSearch" class="block text-sm font-medium">Location</label>
                            <div class="mt-1 flex gap-2">
                                <input type="text" id="locationSearch" placeholder="e.g., Moab, UT" class="block w-full bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <button id="searchLocationBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-800">Search</button>
                                <button id="myLocationBtn" title="Use my current location" class="p-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 dark:focus:ring-offset-gray-800">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                            <div id="location-spinner" class="hidden mt-2 flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400"><div class="loader" style="width:16px; height:16px; border-width:2px;"></div><span id="location-status-text">Fetching location...</span></div>
                        </div>
                        <div>
                            <label for="forecastDate" class="block text-sm font-medium">Forecast Date</label>
                            <input type="date" id="forecastDate" class="mt-1 block w-full bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-4 border-b border-gray-200 dark:border-gray-700 pb-2">Your Appliances</h2>
                    <div class="flex gap-2">
                        <select id="applianceSelector" class="block w-full bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </select>
                        <button id="addApplianceBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 dark:focus:ring-offset-gray-800">Add</button>
                    </div>
                    <div class="mt-4 grid grid-cols-[1fr,auto,auto,auto] gap-2 items-center px-2 text-sm font-semibold text-gray-500 dark:text-gray-400">
                        <span>Appliance</span>
                        <span class="text-center w-20">Watts</span>
                        <span class="text-center w-20">Hours/Day</span>
                        <span class="w-7"></span> </div>
                    <div id="applianceList" class="mt-1 space-y-3">
                        </div>
                </div>
            </div>

            <div class="xl:col-span-3 flex flex-col gap-8">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md relative">
                     <div id="results-spinner" class="hidden absolute inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-10"><div class="loader"></div></div>
                    <h2 class="text-xl font-bold mb-4 border-b border-gray-200 dark:border-gray-700 pb-2">Results & Suggestions</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-red-100 dark:bg-red-900/50 p-4 rounded-lg text-center">
                            <h3 class="text-sm font-medium text-red-800 dark:text-red-300">Daily Power Draw</h3>
                            <p id="dailyDraw" class="text-2xl font-bold text-red-900 dark:text-red-200">-</p>
                        </div>
                        <div class="bg-yellow-100 dark:bg-yellow-900/50 p-4 rounded-lg text-center">
                            <h3 class="text-sm font-medium text-yellow-800 dark:text-yellow-300">Est. Solar Generation</h3>
                            <p id="solarGeneration" class="text-2xl font-bold text-yellow-900 dark:text-yellow-200">-</p>
                        </div>
                        <div class="bg-green-100 dark:bg-green-900/50 p-4 rounded-lg text-center">
                            <h3 class="text-sm font-medium text-green-800 dark:text-green-300">Estimated Runtime</h3>
                            <p id="estimatedRuntime" class="text-2xl font-bold text-green-900 dark:text-green-200">-</p>
                        </div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-gray-100 dark:bg-gray-700/50 p-4 rounded-lg text-center">
                            <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300">Total Daylight</h3>
                            <p id="totalDaylight" class="text-lg font-semibold text-gray-800 dark:text-gray-100">-</p>
                        </div>
                        <div class="bg-gray-100 dark:bg-gray-700/50 p-4 rounded-lg text-center">
                            <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300">Effective Sun (PSH)</h3>
                            <p id="effectiveSunHours" class="text-lg font-semibold text-gray-800 dark:text-gray-100">-</p>
                        </div>
                        <div class="bg-gray-100 dark:bg-gray-700/50 p-4 rounded-lg text-center">
                            <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300">Weather Forecast</h3>
                            <p id="weatherForecast" class="text-lg font-semibold text-gray-800 dark:text-gray-100">-</p>
                        </div>
                    </div>
                    <div id="suggestionBox" class="mt-4 p-4 rounded-lg bg-blue-100 dark:bg-blue-900/50">
                         <h3 class="font-bold text-blue-800 dark:text-blue-300 flex items-center gap-2">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                             Suggestion Box
                         </h3>
                         <p id="suggestionText" class="mt-2 text-sm text-blue-900 dark:text-blue-200">Set a location to begin your 24-hour forecast.</p>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-4">24-Hour Power Forecast</h2>
                    <div id="graphPlaceholder" class="h-96 flex flex-col items-center justify-center text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <p class="text-lg font-semibold text-gray-600 dark:text-gray-400">Find location to reveal solar tracking estimates</p>
                    </div>
                    <div id="graphContainer" class="h-96 hidden">
                        <canvas id="powerChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM ELEMENTS ---
        const batteryCapacityEl = document.getElementById('batteryCapacity');
        const batteryTypeEl = document.getElementById('batteryType');
        const solarWattageEl = document.getElementById('solarWattage');
        const locationSearchEl = document.getElementById('locationSearch');
        const searchLocationBtn = document.getElementById('searchLocationBtn');
        const myLocationBtn = document.getElementById('myLocationBtn');
        const forecastDateEl = document.getElementById('forecastDate');
        const applianceSelectorEl = document.getElementById('applianceSelector');
        const addApplianceBtn = document.getElementById('addApplianceBtn');
        const applianceListEl = document.getElementById('applianceList');
        
        // Output elements
        const dailyDrawEl = document.getElementById('dailyDraw');
        const solarGenerationEl = document.getElementById('solarGeneration');
        const estimatedRuntimeEl = document.getElementById('estimatedRuntime');
        const totalDaylightEl = document.getElementById('totalDaylight');
        const effectiveSunHoursEl = document.getElementById('effectiveSunHours');
        const weatherForecastEl = document.getElementById('weatherForecast');
        const suggestionBoxEl = document.getElementById('suggestionBox');
        const suggestionTextEl = document.getElementById('suggestionText');
        const locationSpinner = document.getElementById('location-spinner');
        const locationStatusText = document.getElementById('location-status-text');
        const resultsSpinner = document.getElementById('results-spinner');
        const graphPlaceholderEl = document.getElementById('graphPlaceholder');
        const graphContainerEl = document.getElementById('graphContainer');
        
        // --- STATE & CONFIG ---
        let chart;
        let currentLocation = null; // No default location on start
        let applianceIdCounter = 0;
        let locationIsSet = false;
        let hourlyConsumptionBreakdown = [];


        const APPLIANCE_PRESETS = {
            'Compressor Fridge/Freezer': { watts: 50, pattern: 'fridge_intermittent' },
            'Water Pump': { watts: 60, pattern: 'intermittent' },
            'LED Lighting (Internal)': { watts: 10, pattern: 'evening' },
            'Phone/Tablet Charging (USB)': { watts: 15, pattern: 'intermittent' },
            '12V Television': { watts: 30, pattern: 'evening' },
            'Roof Vent Fan (e.g., Maxxfan)': { watts: 20, pattern: 'night' },
            'Rangehood/Extractor Fan': { watts: 15, pattern: 'meal-times' },
            'Diesel/Gas Heater Fan': { watts: 20, pattern: 'night' },
            'Stereo/Radio': { watts: 15, pattern: 'daytime' },
            'Awning/Exterior LED Lights': { watts: 10, pattern: 'evening' },
            'BMS & Monitors': { watts: 2, pattern: 'all-day' },
            'Gas Detector / Smoke Alarm': { watts: 1, pattern: 'all-day' },
            'Laptop Charging': { watts: 65, pattern: 'daytime' },
            'Starlink (Standard)': { watts: 55, pattern: 'all-day' },
            'Starlink Mini': { watts: 30, pattern: 'all-day' },
            'Cel-Fi Go Booster': { watts: 15, pattern: 'all-day' },
            'Air Conditioner': { watts: 1600, pattern: 'daytime' },
            'Microwave Oven': { watts: 1150, pattern: 'meal-times' },
            'Coffee Machine (Pod)': { watts: 1250, pattern: 'meal-times' },
            'Electric Kettle (240V)': { watts: 2000, pattern: 'meal-times' },
            'Induction Cooktop (Single)': { watts: 1900, pattern: 'meal-times' },
            'Air Fryer': { watts: 1500, pattern: 'meal-times' },
            'Washing Machine (Compact)': { watts: 250, pattern: 'daytime' },
            'Toaster': { watts: 800, pattern: 'meal-times' },
            'Hair Dryer': { watts: 1600, pattern: 'daytime' },
            'CPAP Machine': { watts: 50, pattern: 'night' },
            'Thermomix/Blender (Peak)': { watts: 1500, pattern: 'meal-times' },
            'Air Compressor (Tyres)': { watts: 700, pattern: 'intermittent' },
            '12V Travel Oven': { watts: 120, pattern: 'daytime' },
            'Vacuum Cleaner (Charging)': { watts: 25, pattern: 'intermittent' },
            'Electric Blanket (12V)': { watts: 50, pattern: 'night' },
            'Security Camera (12V)': { watts: 5, pattern: 'all-day' },
            'Power Tool Battery Charger': { watts: 150, pattern: 'daytime' },
            'Water Purifier (UV)': { watts: 8, pattern: 'intermittent' },
            'Electric Awning Motor': { watts: 30, pattern: 'intermittent' },
            'Electric Toilet': { watts: 5, pattern: 'intermittent' }
        };
        
        const WEATHER_CODES = {
            0: { name: "Clear sky", modifier: 1.0 },
            1: { name: "Mainly clear", modifier: 0.95 },
            2: { name: "Partly cloudy", modifier: 0.85 },
            3: { name: "Overcast", modifier: 0.6 },
            45: { name: "Fog", modifier: 0.4 },
            48: { name: "Depositing rime fog", modifier: 0.35 },
            51: { name: "Light drizzle", modifier: 0.5 },
            53: { name: "Moderate drizzle", modifier: 0.45 },
            55: { name: "Dense drizzle", modifier: 0.4 },
            61: { name: "Slight rain", modifier: 0.4 },
            63: { name: "Moderate rain", modifier: 0.3 },
            65: { name: "Heavy rain", modifier: 0.2 },
            80: { name: "Slight rain showers", modifier: 0.35 },
            81: { name: "Moderate rain showers", modifier: 0.25 },
            82: { name: "Violent rain showers", modifier: 0.15 },
        };
        
        // --- INITIALIZATION ---
        function init() {
            // Populate appliance dropdown first
            const mostCommon = [
                'Compressor Fridge/Freezer', 'Water Pump', 'LED Lighting (Internal)', 
                'Phone/Tablet Charging (USB)', '12V Television', 'Roof Vent Fan (e.g., Maxxfan)',
                'Rangehood/Extractor Fan', 'Diesel/Gas Heater Fan', 'Stereo/Radio',
                'Laptop Charging', 'Starlink (Standard)', 'Starlink Mini', 'BMS & Monitors', 'Gas Detector / Smoke Alarm',
                'Cel-Fi Go Booster'
            ];

            const highDemand = Object.keys(APPLIANCE_PRESETS).filter(k => !mostCommon.includes(k));

            const commonGroup = document.createElement('optgroup');
            commonGroup.label = 'Most Common Appliances';
            mostCommon.sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                commonGroup.appendChild(option);
            });

            const highDemandGroup = document.createElement('optgroup');
            highDemandGroup.label = 'High-Demand & Other';
            highDemand.sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                highDemandGroup.appendChild(option);
            });
            
            applianceSelectorEl.appendChild(commonGroup);
            applianceSelectorEl.appendChild(highDemandGroup);
            
            // Load data from localStorage or set defaults
            loadDataFromLocalStorage();

            setupEventListeners();
            initializeChart();
        }

        // --- CHART ---
        function initializeChart() {
            const ctx = document.getElementById('powerChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const color = isDark ? '#d1d5db' : '#374151';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [], // Hourly labels
                    datasets: [
                        {
                            label: 'Consumption (Wh)',
                            data: [],
                            backgroundColor: 'rgba(239, 68, 68, 0.6)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1,
                            yAxisID: 'yPower',
                            order: 2
                        },
                        {
                            label: 'Solar Gen. (Wh)',
                            data: [],
                            backgroundColor: 'rgba(234, 179, 8, 0.6)',
                            borderColor: 'rgba(234, 179, 8, 1)',
                            borderWidth: 1,
                            yAxisID: 'yPower',
                            order: 2
                        },
                         {
                            label: 'Battery Charge (%)',
                            data: [],
                            type: 'line',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'yPercentage',
                            pointRadius: 0,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                           type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'HH:mm'
                                }
                            },
                            grid: { color: gridColor },
                            ticks: { color: color }
                        },
                        yPower: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Energy (Wh)',
                                color: color
                            },
                            grid: { color: gridColor },
                            ticks: { color: color }
                        },
                        yPercentage: {
                            type: 'linear',
                            position: 'right',
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Battery (%)',
                                color: color
                            },
                            grid: { drawOnChartArea: false }, // only display ticks and lines for this axis
                            ticks: {
                                color: color,
                                callback: value => value + '%'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                footer: function(tooltipItems) {
                                    const hourIndex = tooltipItems[0].dataIndex;
                                    if (hourlyConsumptionBreakdown && hourlyConsumptionBreakdown[hourIndex]) {
                                        const breakdown = hourlyConsumptionBreakdown[hourIndex];
                                        if (breakdown.length > 0) {
                                            const footerLines = ['\nConsumption Breakdown:'];
                                            breakdown.forEach(item => {
                                                footerLines.push(`- ${item.name}: ${Math.round(item.watts)}W`);
                                            });
                                            return footerLines;
                                        }
                                    }
                                    return ''; // No footer if no consumption
                                }
                            }
                        },
                        legend: {
                           labels: {
                                color: color
                           }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                }
            });
        }
        
        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            // Inputs that trigger simulation if location is already set
            const inputs = [batteryCapacityEl, solarWattageEl, forecastDateEl, batteryTypeEl];
            inputs.forEach(el => el.addEventListener('change', () => {
                if (locationIsSet) {
                    updateAndRunSimulation();
                }
            }));

            // Location buttons
            searchLocationBtn.addEventListener('click', handleLocationSearch);
            myLocationBtn.addEventListener('click', handleGetMyPosition);
            locationSearchEl.addEventListener('keypress', (e) => {
                if(e.key === 'Enter') handleLocationSearch();
            });

            // Appliance buttons
            addApplianceBtn.addEventListener('click', () => {
                addAppliance(applianceSelectorEl.value);
                 if (locationIsSet) {
                    updateAndRunSimulation();
                }
            });
            
            // Delegated event listeners for dynamic elements
            applianceListEl.addEventListener('change', (e) => {
                if (e.target.matches('.appliance-watts, .appliance-hours')) {
                     if (locationIsSet) {
                        updateAndRunSimulation();
                    }
                }
            });
            applianceListEl.addEventListener('click', (e) => {
                if (e.target.closest('.delete-appliance')) {
                    e.target.closest('.appliance-item').remove();
                     if (locationIsSet) {
                        updateAndRunSimulation();
                    }
                }
            });
        }

        function revealGraph() {
            if (!locationIsSet) {
                locationIsSet = true;
                graphPlaceholderEl.classList.add('hidden');
                graphContainerEl.classList.remove('hidden');
            }
        }

        // --- LOCATION HANDLING ---
        async function handleLocationSearch() {
            const query = locationSearchEl.value;
            if (!query) return;
            showSpinner('Searching...');
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`);
                if(!response.ok) throw new Error('Network response was not ok.');
                const data = await response.json();
                if (data.length > 0) {
                    currentLocation = {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon),
                        name: data[0].display_name.split(',').slice(0, 2).join(', ')
                    };
                    locationSearchEl.value = currentLocation.name;
                    revealGraph();
                    updateAndRunSimulation();
                } else {
                    alert('Location not found.');
                }
            } catch (error) {
                console.error("Error fetching location:", error);
                alert("Could not fetch location data.");
            } finally {
                hideSpinner();
            }
        }
        
        function handleGetMyPosition() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser.');
                return;
            }
            showSpinner('Getting your location...');
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    currentLocation = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude,
                        name: ''
                    };
                    
                     showSpinner('Fetching location name...');
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${currentLocation.lat}&lon=${currentLocation.lon}&format=json`);
                        const data = await response.json();
                        currentLocation.name = data.address.city || data.address.town || data.address.village || 'Current Location';
                        locationSearchEl.value = currentLocation.name;
                    } catch (error) {
                         console.error("Error reverse geocoding:", error);
                         locationSearchEl.value = 'Current Location';
                    } finally {
                        revealGraph();
                        updateAndRunSimulation();
                        hideSpinner();
                    }
                },
                () => {
                    hideSpinner();
                    alert('Unable to retrieve your location.');
                }
            );
        }

        function showSpinner(text) {
            locationStatusText.textContent = text;
            locationSpinner.classList.remove('hidden');
        }

        function hideSpinner() {
            locationSpinner.classList.add('hidden');
        }

        // --- APPLIANCE HANDLING ---
        function addAppliance(name, hours = null, watts = null) {
            const preset = APPLIANCE_PRESETS[name];
            if (!preset) return;

            let defaultHours = 1;
            if (name.toLowerCase().includes('microwave')) {
                defaultHours = 0.1; // 6 minutes
            }

            const finalHours = (hours !== null) ? hours : defaultHours;
            const finalWatts = (watts !== null) ? watts : preset.watts;

            applianceIdCounter++;
            const div = document.createElement('div');
            div.className = 'appliance-item grid grid-cols-[1fr,auto,auto,auto] gap-2 items-center bg-gray-50 dark:bg-gray-700/50 px-2 py-1 rounded-md';
            div.innerHTML = `
                <span class="font-medium truncate" title="${name}">${name}</span>
                <input type="number" value="${finalWatts}" class="appliance-watts w-20 text-center bg-white dark:bg-gray-600 border-gray-300 dark:border-gray-500 rounded-md shadow-sm">
                <input type="number" step="0.25" value="${finalHours}" class="appliance-hours w-20 text-center bg-white dark:bg-gray-600 border-gray-300 dark:border-gray-500 rounded-md shadow-sm">
                <button title="Delete" class="delete-appliance p-1 text-gray-500 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            `;
            div.dataset.name = name;
            applianceListEl.appendChild(div);
        }

        // --- MAIN SIMULATION LOGIC ---
        let simulationDebounceTimer;
        function updateAndRunSimulation() {
            saveDataToLocalStorage();
            if (!locationIsSet) return;
            clearTimeout(simulationDebounceTimer);
            resultsSpinner.classList.remove('hidden');
            simulationDebounceTimer = setTimeout(runSimulation, 300); // Debounce to prevent rapid calls
        }
        
        async function runSimulation() {
            // 1. GATHER INPUTS
            const batteryType = batteryTypeEl.value;
            const inputs = {
                batteryCapacityAh: parseFloat(batteryCapacityEl.value),
                usableCapacity: batteryType === 'lithium' ? 0.9 : 0.5,
                systemVoltage: 12, // Hardcoded to 12V
                solarWattage: parseFloat(solarWattageEl.value),
                date: forecastDateEl.value,
                lat: currentLocation.lat,
                lon: currentLocation.lon,
                appliances: Array.from(applianceListEl.children).map(el => ({
                    name: el.dataset.name,
                    watts: parseFloat(el.querySelector('.appliance-watts').value),
                    hours: parseFloat(el.querySelector('.appliance-hours').value),
                    pattern: APPLIANCE_PRESETS[el.dataset.name].pattern
                }))
            };
            
            if (Object.values(inputs).some(v => isNaN(v) && typeof v !== 'object' && typeof v !== 'string') || !inputs.date) {
                resultsSpinner.classList.add('hidden');
                suggestionTextEl.textContent = "Please fill in all system setup values.";
                return;
            }

            // 2. PREPARE DATES & FETCH WEATHER
            const localDayStart = new Date(inputs.date + 'T00:00:00');
            const apiStartDate = localDayStart.toISOString().split('T')[0];
            const apiEndDate = apiStartDate;
            
            const weatherData = await getWeatherData(inputs.lat, inputs.lon, apiStartDate, apiEndDate);
            if (!weatherData || !weatherData.hourly || !weatherData.hourly.time) {
                resultsSpinner.classList.add('hidden');
                alert("Failed to get valid weather data. The forecast may be inaccurate.");
                return;
            }

            // 3. CALCULATE SUN TIMES
            const sunTimes = calculateSunTimes(new Date(inputs.date + 'T12:00:00'), inputs.lat, inputs.lon);
            
            // 4. PREPARE SIMULATION ARRAYS
            const totalBatteryWh = inputs.batteryCapacityAh * inputs.systemVoltage;
            const usableBatteryWh = totalBatteryWh * inputs.usableCapacity;
            let currentBatteryWh = usableBatteryWh;

            const hourlyConsumption = new Array(24).fill(0);
            const hourlySolar = new Array(24).fill(0);
            const hourlyBatterySOC = new Array(24).fill(0);
            hourlyConsumptionBreakdown = Array.from({ length: 24 }, () => []);

            // 5. DISTRIBUTE APPLIANCE LOAD
            inputs.appliances.forEach(appliance => {
                let hoursLeft = appliance.hours;
                if (isNaN(hoursLeft) || hoursLeft <= 0) return;
                
                if (appliance.pattern === 'fridge_intermittent') {
                    const avgWatts = (appliance.watts * hoursLeft) / 24;
                    for (let i = 0; i < 24; i++) {
                        hourlyConsumption[i] += avgWatts;
                        hourlyConsumptionBreakdown[i].push({ name: appliance.name, watts: avgWatts });
                    }
                    return;
                }

                const getHoursForPattern = (pattern) => {
                    switch(pattern) {
                        case 'daytime': return Array.from({length: 11}, (_, i) => i + 7);
                        case 'evening': return [18, 19, 20, 21, 22, 23];
                        case 'night': return [0, 1, 2, 3, 4, 5, 6, 22, 23];
                        case 'all-day': return Array.from({length: 24}, (_, i) => i);
                        case 'meal-times': return [7, 8, 12, 13, 18, 19];
                        case 'intermittent':
                        default:
                           return [7, 8, 12, 13, 17, 18, 19, 20];
                    }
                };
                
                const usageHours = getHoursForPattern(appliance.pattern);
                let hoursToDistribute = Math.ceil(hoursLeft);

                for(let i = 0; i < hoursToDistribute; i++){
                    const hourIndex = usageHours[i % usageHours.length];
                    const consumptionForHour = (hoursLeft > 1) ? appliance.watts : appliance.watts * hoursLeft;
                    hourlyConsumption[hourIndex] += consumptionForHour;
                    hourlyConsumptionBreakdown[hourIndex].push({ name: appliance.name, watts: consumptionForHour });
                    hoursLeft -= 1;
                    if(hoursLeft <= 0) break;
                }
            });

            // 6. RUN HOURLY SIMULATION
            for (let hour = 0; hour < 24; hour++) {
                const localHourDate = new Date(localDayStart.getTime() + hour * 3600 * 1000);
                const utcHourStringForWeather = localHourDate.toISOString().slice(0, 14) + "00";
                const weatherIndex = weatherData.hourly.time.findIndex(t => t === utcHourStringForWeather);
                const weatherCode = (weatherIndex !== -1) ? weatherData.hourly.weather_code[weatherIndex] : 3;

                let solarWh = 0;
                if (localHourDate > sunTimes.sunrise && localHourDate < sunTimes.sunset) {
                    const daylightHours = (sunTimes.sunset - sunTimes.sunrise) / 1000 / 3600;
                    const timeSinceSunrise = (localHourDate - sunTimes.sunrise) / 1000 / 3600;
                    const solarIntensity = Math.sin((timeSinceSunrise / daylightHours) * Math.PI);
                    const weatherModifier = WEATHER_CODES[weatherCode]?.modifier ?? 0.7;
                    solarWh = inputs.solarWattage * solarIntensity * weatherModifier;
                }
                hourlySolar[hour] = solarWh;

                const netWh = hourlySolar[hour] - hourlyConsumption[hour];
                currentBatteryWh += netWh;
                currentBatteryWh = Math.max(0, Math.min(currentBatteryWh, usableBatteryWh));
                hourlyBatterySOC[hour] = (usableBatteryWh > 0) ? (currentBatteryWh / usableBatteryWh) * 100 : 0;
            }
            
            // 7. UPDATE UI
            updateResultsUI(hourlyConsumption, hourlySolar, hourlyBatterySOC, usableBatteryWh, weatherData, sunTimes, inputs.solarWattage);
            updateChartUI(hourlyConsumption, hourlySolar, hourlyBatterySOC, inputs.date);
            resultsSpinner.classList.add('hidden');
        }

        // --- DATA PERSISTENCE ---
        function saveDataToLocalStorage() {
            const dataToSave = {
                batteryCapacity: batteryCapacityEl.value,
                batteryType: batteryTypeEl.value,
                solarWattage: solarWattageEl.value,
                location: currentLocation,
                date: forecastDateEl.value,
                appliances: Array.from(applianceListEl.children).map(el => ({
                    name: el.dataset.name,
                    watts: el.querySelector('.appliance-watts').value,
                    hours: el.querySelector('.appliance-hours').value
                }))
            };
            localStorage.setItem('caravanCalculatorData', JSON.stringify(dataToSave));
        }

        function loadDataFromLocalStorage() {
            const savedData = localStorage.getItem('caravanCalculatorData');
            if (savedData) {
                const data = JSON.parse(savedData);
                batteryCapacityEl.value = data.batteryCapacity;
                batteryTypeEl.value = data.batteryType;
                solarWattageEl.value = data.solarWattage;
                forecastDateEl.value = data.date;
                
                if (data.location) {
                    currentLocation = data.location;
                    locationSearchEl.value = data.location.name;
                    revealGraph();
                    updateAndRunSimulation();
                }

                applianceListEl.innerHTML = ''; // Clear defaults
                if (data.appliances.length > 0) {
                    data.appliances.forEach(app => addAppliance(app.name, app.hours, app.watts));
                } else {
                    addDefaultAppliances();
                }

            } else {
                 // Set date to today if no saved data
                const today = new Date();
                forecastDateEl.value = today.toISOString().split('T')[0];
                addDefaultAppliances();
            }
        }
        
        function addDefaultAppliances() {
            addAppliance('Compressor Fridge/Freezer', 8);
            addAppliance('LED Lighting (Internal)', 4);
            addAppliance('Water Pump', 0.25);
            addAppliance('Diesel/Gas Heater Fan', 6);
            addAppliance('Roof Vent Fan (e.g., Maxxfan)', 8);
            addAppliance('Phone/Tablet Charging (USB)', 2);
            addAppliance('Starlink (Standard)', 6);
        }


        // --- API & CALCULATION HELPERS ---
        async function getWeatherData(lat, lon, startDate, endDate) {
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=weather_code&start_date=${startDate}&end_date=${endDate}`;
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error("Weather API request failed");
                return await response.json();
            } catch (error) {
                console.error("Error fetching weather data:", error);
                alert("Could not fetch weather data. Please check your connection or try again later.");
                return null;
            }
        }

        function calculateSunTimes(date, lat, lon) {
            const dayMs = 1000 * 60 * 60 * 24;
            const J1970 = 2440588;
            const J2000 = 2451545;
            
            const toRad = (d) => d * Math.PI / 180;
            const toDeg = (r) => r * 180 / Math.PI;

            const lw = toRad(-lon);
            const phi = toRad(lat);
            
            const d = (date.getTime() / dayMs) - 0.5 + J1970 - J2000;
            
            const M = toRad(357.5291 + 0.98560028 * d);
            const L = toRad(280.460 + 0.9856474 * d);
            const C = 1.9148 * Math.sin(M) + 0.02 * Math.sin(2 * M) + 0.0003 * Math.sin(3 * M);
            const lambda = toRad(toDeg(L) + C);
            
            const dec = Math.asin(Math.sin(toRad(23.44)) * Math.sin(lambda));
            const H = Math.acos((Math.sin(toRad(-0.83)) - Math.sin(phi) * Math.sin(dec)) / (Math.cos(phi) * Math.cos(dec)));
            
            const J_noon = J2000 + d - lw / (2 * Math.PI);
            const J_set = J_noon + toDeg(H) / 360;
            const J_rise = J_noon - toDeg(H) / 360;

            const dateRise = new Date((J_rise - J1970) * dayMs);
            const dateSet = new Date((J_set - J1970) * dayMs);

            return { sunrise: dateRise, sunset: dateSet };
        }
        
        // --- UI UPDATE FUNCTIONS ---
        function updateResultsUI(consumption, solar, batterySOC, usableBatteryWh, weatherData, sunTimes, solarPanelWatts) {
            const totalDraw = consumption.reduce((a, b) => a + b, 0);
            const totalSolar = solar.reduce((a, b) => a + b, 0);

            dailyDrawEl.textContent = `${Math.round(totalDraw).toLocaleString()} Wh`;
            solarGenerationEl.textContent = `${Math.round(totalSolar).toLocaleString()} Wh`;
            
            const firstEmptyHour = batterySOC.findIndex(soc => soc < 1);
            if (firstEmptyHour === -1) {
                if(totalSolar > totalDraw){
                   estimatedRuntimeEl.textContent = "Sustainable";
                   estimatedRuntimeEl.className = "text-2xl font-bold text-green-900 dark:text-green-200";
                } else {
                    estimatedRuntimeEl.textContent = "Deficit";
                    estimatedRuntimeEl.className = "text-2xl font-bold text-yellow-600 dark:text-yellow-400";
                }
            } else {
                estimatedRuntimeEl.textContent = `~${firstEmptyHour} hours`;
                estimatedRuntimeEl.className = "text-2xl font-bold text-red-900 dark:text-red-200";
            }
            
            const daylightHours = (sunTimes.sunset - sunTimes.sunrise) / 1000 / 3600;
            totalDaylightEl.textContent = `${daylightHours.toFixed(1)} hours`;

            const effectiveSun = solarPanelWatts > 0 ? totalSolar / solarPanelWatts : 0;
            effectiveSunHoursEl.textContent = `${effectiveSun.toFixed(1)} hours`;

            const dominantWeatherCode = getDominantWeather(weatherData.hourly.weather_code);
            weatherForecastEl.textContent = WEATHER_CODES[dominantWeatherCode]?.name ?? "Varied";

            updateSuggestionBox(totalDraw, totalSolar, firstEmptyHour, usableBatteryWh);
        }

        function updateSuggestionBox(draw, solar, emptyHour, usableBatteryWh) {
             let message = "";
             let type = "info";

             if (emptyHour !== -1) {
                 message = `CRITICAL: Your battery is projected to run out in about ${emptyHour} hours. Reduce load immediately.`;
                 type = "critical";
             } else if (solar < draw) {
                 const deficit = draw - solar;
                 const runtimeHours = usableBatteryWh / deficit;
                 message = `WARNING: You have a daily power deficit of ${Math.round(deficit)} Wh. Your battery can sustain this for approximately ${runtimeHours.toFixed(0)} hours. Consider reducing load or adding more solar.`;
                 type = "warning";
             } else {
                 const surplus = solar - draw;
                 message = `GOOD: You have a daily power surplus of ${Math.round(surplus)} Wh. Your system is stable for the selected load and conditions.`;
                 type = "info";
             }
             
            suggestionTextEl.textContent = message;
            const colors = {
                info: 'bg-blue-100 dark:bg-blue-900/50',
                warning: 'bg-yellow-100 dark:bg-yellow-900/50',
                critical: 'bg-red-100 dark:bg-red-900/50'
            };
            const textColors = {
                 info: 'text-blue-900 dark:text-blue-200',
                 warning: 'text-yellow-900 dark:text-yellow-200',
                 critical: 'text-red-900 dark:text-red-200'
            };
            suggestionBoxEl.className = `mt-4 p-4 rounded-lg ${colors[type]}`;
            suggestionTextEl.className = `mt-2 text-sm ${textColors[type]}`;
        }
        
        function getDominantWeather(codes) {
            const counts = (codes || []).reduce((acc, code) => {
                acc[code] = (acc[code] || 0) + 1;
                return acc;
            }, {});
            if (Object.keys(counts).length === 0) return "N/A";
            return Object.keys(counts).reduce((a,b) => counts[a] > counts[b] ? a : b);
        }

        function updateChartUI(consumption, solar, batterySOC, date) {
            const localDayStart = new Date(date + 'T00:00:00');
            const labels = Array.from({ length: 24 }, (_, i) => {
                return new Date(localDayStart.getTime() + i * 3600 * 1000);
            });
            
            chart.data.labels = labels;
            chart.data.datasets[0].data = consumption;
            chart.data.datasets[1].data = solar;
            chart.data.datasets[2].data = batterySOC;
            chart.update();
        }

        // --- START THE APP ---
        init();
    });
    </script>
</body>
</html>
